<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bakesuki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lobster&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDF4F0; }
        .font-lobster { font-family: 'Lobster', cursive; }
        .bakesuki-brand-text { color: #6D2828; }
        .btn-primary { background-color: #D98B99; color: white; }
        .btn-primary:hover { background-color: #C77583; }
        .btn-secondary { background-color: #a78bfa; color: white; }
        .btn-secondary:hover { background-color: #8b5cf6; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-edit { background-color: #fbbf24; color: white; }
        .btn-edit:hover { background-color: #f59e0b; }

        /* Contenedor desplegable con scroll */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.open {
            max-height: 60vh; /* Altura m√°xima del 60% de la pantalla */
            overflow-y: auto; /* Scroll vertical si el contenido es m√°s alto */
        }

        /* Estilo de la barra de scroll */
        .collapsible-content::-webkit-scrollbar {
            width: 8px;
        }
        .collapsible-content::-webkit-scrollbar-track {
            background: #F9EBE4;
            border-radius: 10px;
        }
        .collapsible-content::-webkit-scrollbar-thumb {
            background: #D98B99;
            border-radius: 10px;
        }
        .collapsible-content::-webkit-scrollbar-thumb:hover {
            background: #C77583;
        }

        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #22c55e; }
        input:checked + .slider:before { transform: translateX(22px); }
        /* Animaci√≥n de clic */
        @keyframes click-effect {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .clicked {
            animation: click-effect 0.2s ease-out;
        }
    </style>
</head>
<body class="text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-5xl font-lobster bakesuki-brand-text">Panel de Administraci√≥n</h1>
        <p class="text-xl text-gray-500 mt-2">Bakesuki</p>
    </header>

    <!-- Secci√≥n de Ganancias y Filtros -->
    <section class="mb-12 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-bold bakesuki-brand-text">Ganancias del Per√≠odo</h2>
            <div id="ganancias-trigger" class="cursor-pointer">
                <p id="ganancias-periodo" class="text-4xl font-bold text-blue-500 mt-2">Gs. 0</p>
                <span class="text-xs text-gray-400">toca para ver detalles ‚ñº</span>
            </div>
            <div id="ganancias-detalle" class="collapsible-content mt-4 text-left border-t pt-4">
                <div class="flex justify-between text-gray-700">
                    <span>Efectivo:</span>
                    <span id="ganancias-efectivo" class="font-semibold">Gs. 0</span>
                </div>
                <div class="flex justify-between text-gray-700 mt-1">
                    <span>Transferencia:</span>
                    <span id="ganancias-transferencia" class="font-semibold">Gs. 0</span>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-bold bakesuki-brand-text mb-4">Filtrar por Fecha</h2>
            <div class="flex flex-col sm:flex-row gap-2 items-center justify-center">
                <div>
                    <label for="fecha-inicio" class="text-sm font-semibold">Desde:</label>
                    <input type="date" id="fecha-inicio" class="border-gray-300 rounded-md text-sm">
                </div>
                <div>
                    <label for="fecha-fin" class="text-sm font-semibold">Hasta:</label>
                    <input type="date" id="fecha-fin" class="border-gray-300 rounded-md text-sm">
                </div>
                <button id="fecha-actual-btn" class="btn-primary text-sm font-bold py-2 px-3 rounded-lg">Hoy</button>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Columna de Pedidos -->
        <section>
            <div class="mb-6">
                <input type="search" id="search-pedidos" placeholder="üîç Buscar pedido por nombre..." class="w-full p-2 border-gray-300 rounded-md shadow-sm">
            </div>
            <div class="space-y-6">
                <!-- Pedidos Pendientes -->
                <div>
                    <button class="collapsible-trigger w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100">Pedidos Pendientes</button>
                    <div class="collapsible-content open">
                        <div id="pedidos-pendientes-contenedor" class="space-y-4 p-1"></div>
                    </div>
                </div>
                <!-- Pedidos por Pagar -->
                <div>
                    <button class="collapsible-trigger w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100">Pedidos por Pagar</button>
                    <div class="collapsible-content">
                        <div id="pedidos-confirmados-contenedor" class="space-y-4 p-1"></div>
                    </div>
                </div>
                <!-- Pedidos Entregados -->
                <div>
                    <div class="flex justify-between items-center mb-4 p-2 rounded-lg hover:bg-pink-100">
                        <button class="collapsible-trigger text-left text-2xl font-bold bakesuki-brand-text">Pedidos Entregados</button>
                    </div>
                    <div class="collapsible-content">
                        <div id="pedidos-entregados-contenedor" class="space-y-4 p-1"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Columna de Productos -->
        <section>
            <!-- Gesti√≥n de Stock -->
            <div>
                <button class="collapsible-trigger w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100">Gesti√≥n de Productos</button>
                <div class="collapsible-content open">
                    <div id="productos-contenedor" class="space-y-4 p-1"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Supabase SDK -->
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://uyrylcylwkhqxseplquqp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cnlsY3l3a2hxeHNlcGxxdXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0OTA1NDYsImV4cCI6MjA3MTA2NjU0Nn0.0K3nPF1PMdR5qrRlp1Wv9zyBfFOtdTrmKqmT75e6J7Q';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const gananciasDetalle = document.getElementById('ganancias-detalle');
    const gananciasEfectivo = document.getElementById('ganancias-efectivo');
    const gananciasTransferencia = document.getElementById('ganancias-transferencia');
    const gananciasPeriodoContenedor = document.getElementById('ganancias-periodo');
    const pedidosPendientesContenedor = document.getElementById('pedidos-pendientes-contenedor');
    const pedidosConfirmadosContenedor = document.getElementById('pedidos-confirmados-contenedor');
    const pedidosEntregadosContenedor = document.getElementById('pedidos-entregados-contenedor');
    const productosContenedor = document.getElementById('productos-contenedor');
    const searchInput = document.getElementById('search-pedidos');
    const fechaInicioInput = document.getElementById('fecha-inicio');
    const fechaFinInput = document.getElementById('fecha-fin');

    let todosLosPedidos = [];

    const formatearPrecio = (valor) => new Intl.NumberFormat('es-PY', { style: 'currency', currency: 'PYG', maximumFractionDigits: 0 }).format(valor);

    async function cargarDatos() {
        // Cargar Pedidos
        const { data, error } = await supabase.from('pedidos').select('*').order('created_at', { ascending: true });
        if (error) {
            console.error('Error al cargar todos los pedidos:', error);
        } else {
            todosLosPedidos = data;
            filtrarYRenderizarPedidos();
        }

        // Cargar Productos
        const { data: productos, error: errorProductos } = await supabase.from('productos').select('*').order('nombre');
        if (errorProductos) console.error('Error al cargar productos:', errorProductos);
        else renderizarProductos(productos);
    }

    function filtrarYRenderizarPedidos() {
        const searchTerm = searchInput.value.toLowerCase();
        const fechaInicio = fechaInicioInput.value;
        const fechaFin = fechaFinInput.value;

        let pedidosFiltrados = todosLosPedidos.filter(p => p.nombre_cliente && p.nombre_cliente.toLowerCase().includes(searchTerm));

        const pendientes = pedidosFiltrados.filter(p => !p.confirmado);
        const confirmados = pedidosFiltrados.filter(p => p.confirmado && !p.pagado);
        let entregados = pedidosFiltrados.filter(p => p.pagado);

        // Filtrar entregados por fecha si se ha seleccionado un rango
        let entregadosFiltrados = entregados;
        if (fechaInicio || fechaFin) {
            entregadosFiltrados = entregados.filter(p => {
                const fechaPedido = new Date(p.created_at).toISOString().split('T')[0];
                const inicio = fechaInicio || '1970-01-01';
                const fin = fechaFin || '9999-12-31';
                return fechaPedido >= inicio && fechaPedido <= fin;
            });
        }

        const gananciasPeriodo = entregadosFiltrados.reduce((sum, p) => sum + p.total, 0);
        gananciasPeriodoContenedor.textContent = formatearPrecio(gananciasPeriodo);

        let totalEfectivoPeriodo = 0;
        let totalTransferenciaPeriodo = 0;
        entregadosFiltrados.forEach(pedido => {
            if (pedido.metodo_pago === 'Efectivo') totalEfectivoPeriodo += pedido.total;
            else if (pedido.metodo_pago === 'Transferencia') totalTransferenciaPeriodo += pedido.total;
        });
        gananciasEfectivo.textContent = formatearPrecio(totalEfectivoPeriodo);
        gananciasTransferencia.textContent = formatearPrecio(totalTransferenciaPeriodo);

        renderizarPedidos(pendientes, pedidosPendientesContenedor, 'pendientes');
        renderizarPedidos(confirmados, pedidosConfirmadosContenedor, 'confirmados');
        renderizarPedidos(entregadosFiltrados, pedidosEntregadosContenedor, 'entregados');
    }

    function renderizarPedidos(pedidos, contenedor, tipo) {
        contenedor.innerHTML = '';
        if (pedidos.length === 0) {
            contenedor.innerHTML = `<p class="text-center text-gray-500">No hay pedidos en esta secci√≥n.</p>`;
            return;
        }
        pedidos.forEach(pedido => {
            const pedidoCard = document.createElement('div');
            pedidoCard.className = 'bg-white p-4 rounded-lg shadow-sm';
            let controlesHTML = '';

            if (tipo === 'pendientes') {
                controlesHTML = `
                        <button data-id="${pedido.id}" class="confirmar-pedido-btn btn-secondary text-sm font-bold py-1 px-3 rounded-lg">Confirmar</button>
                        <button data-id="${pedido.id}" class="eliminar-pedido-btn btn-danger text-sm font-bold py-1 px-3 rounded-lg">Eliminar</button>
                    `;
            } else if (tipo === 'confirmados') {
                controlesHTML = `
                        <button data-id="${pedido.id}" class="cancelar-pedido-btn btn-danger text-sm font-bold py-1 px-3 rounded-lg mr-2">Cancelar</button>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold">${pedido.pagado ? 'Pagado' : 'No Pagado'}</span>
                            <label class="switch">
                                <input type="checkbox" data-id="${pedido.id}" class="pagado-toggle-btn" ${pedido.pagado ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    `;
            } else if (tipo === 'entregados') {
                controlesHTML = `
                        <button data-id="${pedido.id}" class="eliminar-pedido-btn btn-danger text-sm font-bold py-1 px-3 rounded-lg">Borrar</button>
                    `;
            }

            const detalleProductosHTML = pedido.productos_detalle.map(p => `
                    <div class="flex justify-between text-sm">
                        <span>${p.cantidad}x ${p.nombre}</span>
                        <span>${formatearPrecio(p.cantidad * p.precio_unitario)}</span>
                    </div>
                `).join('');

            pedidoCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-sm text-gray-500">${new Date(pedido.created_at).toLocaleString('es-PY')}</p>
                        <p class="font-bold">${formatearPrecio(pedido.total)}</p>
                    </div>
                    <p class="font-semibold mt-2">Cliente: <span class="font-normal">${pedido.nombre_cliente || 'No especificado'}</span></p>
                    <p class="font-semibold mt-1">M√©todo de Pago: <span class="font-normal">${pedido.metodo_pago}</span></p>
                    <div class="mt-2 border-t pt-2 space-y-1">
                        ${detalleProductosHTML}
                    </div>
                    <div class="mt-2 border-t pt-2">
                        <textarea data-id="${pedido.id}" class="notas-internas-textarea w-full border-gray-300 rounded-md text-sm mt-2" rows="2" placeholder="A√±adir nota interna...">${pedido.notas_internas || ''}</textarea>
                        <button data-id="${pedido.id}" class="guardar-nota-btn btn-primary text-xs font-bold py-1 px-2 rounded-lg mt-1">Guardar Nota</button>
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        ${controlesHTML}
                    </div>
                `;
            contenedor.appendChild(pedidoCard);
        });
    }

    function renderizarProductos(productos) {
        productosContenedor.innerHTML = '';
        productos.forEach(producto => {
            const productoCard = document.createElement('div');
            productoCard.className = 'bg-white p-4 rounded-lg shadow-sm';
            productoCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold bakesuki-brand-text">${producto.nombre}</p>
                            <p class="text-sm text-gray-500">Stock actual: <span class="font-bold">${producto.stock}</span></p>
                        </div>
                        <button data-id="${producto.id}" class="editar-producto-btn btn-edit text-sm font-bold py-1 px-3 rounded-lg">Editar</button>
                    </div>
                    <div id="edit-form-${producto.id}" class="collapsible-content mt-4 pt-4 border-t">
                        <form class="form-editar-producto" data-id="${producto.id}">
                            <div class="space-y-2">
                                <div>
                                    <button type="button" class="collapsible-trigger-edit w-full text-left font-semibold bakesuki-brand-text p-2 rounded-lg hover:bg-pink-100">Nombre</button>
                                    <div class="collapsible-content open p-2">
                                        <input name="nombre" type="text" value="${producto.nombre}" class="w-full border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="collapsible-trigger-edit w-full text-left font-semibold bakesuki-brand-text p-2 rounded-lg hover:bg-pink-100">Descripci√≥n</button>
                                    <div class="collapsible-content open p-2">
                                        <textarea name="descripcion" class="w-full border-gray-300 rounded-md text-sm" rows="3">${producto.descripcion}</textarea>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="collapsible-trigger-edit w-full text-left font-semibold bakesuki-brand-text p-2 rounded-lg hover:bg-pink-100">Precio</button>
                                    <div class="collapsible-content open p-2">
                                        <input name="precio" type="number" value="${producto.precio}" class="w-full border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="collapsible-trigger-edit w-full text-left font-semibold bakesuki-brand-text p-2 rounded-lg hover:bg-pink-100">Stock</button>
                                    <div class="collapsible-content open p-2">
                                        <input name="stock" type="number" value="${producto.stock}" class="w-full border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary text-sm font-bold py-2 px-4 rounded-lg mt-2">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                `;
            productosContenedor.appendChild(productoCard);
        });
    }

    // Eventos delegados para los botones
    document.addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.dataset.id;

        // Animaci√≥n de clic
        if (target.tagName === 'BUTTON') {
            target.classList.add('clicked');
            target.addEventListener('animationend', () => {
                target.classList.remove('clicked');
            }, { once: true });
        }

        if (target.classList.contains('confirmar-pedido-btn')) {
            const { error } = await supabase.from('pedidos').update({ confirmado: true }).eq('id', id);
            if (error) console.error('Error al confirmar pedido:', error);
        }

        if (target.classList.contains('cancelar-pedido-btn')) {
            if (confirm('¬øEst√°s seguro de que quieres cancelar este pedido? El stock se devolver√°.')) {
                const { error } = await supabase.from('pedidos').update({ confirmado: false }).eq('id', id);
                if (error) console.error('Error al cancelar pedido:', error);
            }
        }

        if (target.classList.contains('eliminar-pedido-btn')) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este pedido? No afectar√° el stock ni las ganancias.')) {
                const { error } = await supabase.from('pedidos').delete().eq('id', id);
                if (error) console.error('Error al eliminar pedido:', error);
            }
        }

        if (target.classList.contains('editar-producto-btn')) {
            document.getElementById(`edit-form-${id}`).classList.toggle('open');
        }

        if(target.classList.contains('collapsible-trigger')) {
            const content = target.closest('div').querySelector('.collapsible-content');
            if (content) {
                content.classList.toggle('open');
            }
        }
        if(target.classList.contains('collapsible-trigger-edit')) {
            const content = target.nextElementSibling;
            content.classList.toggle('open');
        }
        if(target.id === 'reiniciar-ganancias-btn') {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar las ganancias a cero? Esta acci√≥n no se puede deshacer.')) {
                const { error } = await supabase.from('ganancias').update({ total_ganado: 0 }).eq('id', 1);
                if (error) console.error('Error al reiniciar ganancias:', error);
            }
        }
        if (target.classList.contains('guardar-nota-btn')) {
            const nota = document.querySelector(`.notas-internas-textarea[data-id="${id}"]`).value;
            const { error } = await supabase.from('pedidos').update({ notas_internas: nota }).eq('id', id);
            if (error) console.error('Error al guardar la nota:', error);
        }
        if (target.closest('#ganancias-trigger')) {
            gananciasDetalle.classList.toggle('open');
        }
        if (target.id === 'borrar-entregados-btn') {
            if (confirm('¬øEst√°s seguro de que quieres borrar TODOS los pedidos entregados? Esta acci√≥n es irreversible.')) {
                const { error } = await supabase.from('pedidos').delete().eq('pagado', true);
                if (error) console.error('Error al borrar pedidos entregados:', error);
            }
        }
        if (target.id === 'fecha-actual-btn') {
            const hoy = new Date().toISOString().split('T')[0];
            fechaInicioInput.value = hoy;
            fechaFinInput.value = hoy;
            filtrarYRenderizarPedidos();
        }
    });

    document.addEventListener('submit', async (e) => {
        e.preventDefault();
        const target = e.target;
        const id = target.dataset.id;

        if (target.classList.contains('form-editar-producto')) {
            const formData = new FormData(target);
            const updates = {
                nombre: formData.get('nombre'),
                descripcion: formData.get('descripcion'),
                precio: parseInt(formData.get('precio')),
                stock: parseInt(formData.get('stock')),
            };
            const { error } = await supabase.from('productos').update(updates).eq('id', id);
            if (error) {
                console.error('Error al actualizar producto:', error);
                alert('Error al actualizar el producto.');
            } else {
                document.getElementById(`edit-form-${id}`).classList.remove('open');
            }
        }
    });

    document.addEventListener('change', async (e) => {
        const target = e.target;
        const id = target.dataset.id;
        if (target.classList.contains('pagado-toggle-btn')) {
            const { error } = await supabase.from('pedidos').update({ pagado: target.checked }).eq('id', id);
            if (error) console.error('Error al actualizar estado de pago:', error);
        }
    });

    searchInput.addEventListener('input', filtrarYRenderizarPedidos);
    fechaInicioInput.addEventListener('change', filtrarYRenderizarPedidos);
    fechaFinInput.addEventListener('change', filtrarYRenderizarPedidos);

    // Cargar datos y escuchar cambios en tiempo real
    cargarDatos();

    supabase.channel('public-changes')
        .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
            console.log('Cambio detectado:', payload);
            cargarDatos();
        })
        .subscribe();

</script>
</body>
</html>
