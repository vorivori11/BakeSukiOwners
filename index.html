<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Bakesuki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lobster&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDF4F0; }
        .font-lobster { font-family: 'Lobster', cursive; }
        .bakesuki-brand-text { color: #6D2828; }
        .btn-primary { background-color: #D98B99; color: white; }
        .btn-primary:hover { background-color: #C77583; }
        .btn-secondary { background-color: #a78bfa; color: white; }
        .btn-secondary:hover { background-color: #8b5cf6; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-edit { background-color: #fbbf24; color: white; }
        .btn-edit:hover { background-color: #f59e0b; }

        /* Contenedor desplegable con scroll */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.open {
            max-height: 60vh; /* Altura m√°xima del 60% de la pantalla */
            overflow-y: auto; /* Scroll vertical si el contenido es m√°s alto */
        }

        /* Estilo de la barra de scroll */
        .collapsible-content::-webkit-scrollbar { width: 8px; }
        .collapsible-content::-webkit-scrollbar-track { background: #F9EBE4; border-radius: 10px; }
        .collapsible-content::-webkit-scrollbar-thumb { background: #D98B99; border-radius: 10px; }
        .collapsible-content::-webkit-scrollbar-thumb:hover { background: #C77583; }

        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #22c55e; }
        input:checked + .slider:before { transform: translateX(22px); }
        /* Animaci√≥n de clic */
        @keyframes click-effect {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .clicked {
            animation: click-effect 0.2s ease-out;
        }
    </style>
</head>
<body class="text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-5xl font-lobster bakesuki-brand-text">Panel de Administraci√≥n</h1>
        <p class="text-xl text-gray-500 mt-2">Bakesuki</p>
    </header>

    <!-- Secci√≥n de Ganancias y Filtros -->
    <section class="mb-12 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-bold bakesuki-brand-text">Ganancias del Per√≠odo</h2>
            <div id="ganancias-trigger" class="cursor-pointer">
                <p id="ganancias-periodo" class="text-4xl font-bold text-blue-500 mt-2">Gs. 0</p>
                <span class="text-xs text-gray-400">toca para ver detalles ‚ñº</span>
            </div>
            <div id="ganancias-detalle" class="collapsible-content mt-4 text-left border-t pt-4 space-y-2">
                <div class="flex justify-between text-gray-700">
                    <span>Ingresos (Efectivo):</span>
                    <span id="ganancias-efectivo" class="font-semibold">Gs. 0</span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>Ingresos (Transferencia):</span>
                    <span id="ganancias-transferencia" class="font-semibold">Gs. 0</span>
                </div>
                <div class="flex justify-between text-red-500">
                    <span>Costo de Producci√≥n:</span>
                    <span id="costo-periodo" class="font-semibold">Gs. 0</span>
                </div>
                <div class="flex justify-between text-green-600 font-bold border-t mt-2 pt-2">
                    <span>Ganancia Neta:</span>
                    <span id="ganancia-neta-periodo">Gs. 0</span>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
            <h2 class="text-2xl font-bold bakesuki-brand-text mb-4">Filtrar por Fecha</h2>
            <div class="flex flex-col sm:flex-row gap-2 items-center justify-center">
                <div>
                    <label for="fecha-inicio" class="text-sm font-semibold">Desde:</label>
                    <input type="date" id="fecha-inicio" class="border-gray-300 rounded-md text-sm">
                </div>
                <div>
                    <label for="fecha-fin" class="text-sm font-semibold">Hasta:</label>
                    <input type="date" id="fecha-fin" class="border-gray-300 rounded-md text-sm">
                </div>
                <button id="fecha-actual-btn" class="btn-primary text-sm font-bold py-2 px-3 rounded-lg">Hoy</button>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Columna de Pedidos -->
        <section>
            <div class="mb-6">
                <input type="search" id="search-pedidos" placeholder="üîç Buscar pedido por nombre..." class="w-full p-2 border-gray-300 rounded-md shadow-sm">
            </div>
            <div class="space-y-6">
                <!-- Pedidos Pendientes -->
                <div>
                    <div class="collapsible-header flex justify-between items-center w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100 cursor-pointer">
                        <span>Pedidos Pendientes</span>
                        <span class="transform transition-transform">‚ñº</span>
                    </div>
                    <div class="collapsible-content open">
                        <div id="pedidos-pendientes-contenedor" class="space-y-4 p-1"></div>
                    </div>
                </div>
                <!-- Pedidos por Pagar -->
                <div>
                    <div class="collapsible-header flex justify-between items-center w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100 cursor-pointer">
                        <span>Pedidos por Pagar</span>
                        <span class="transform transition-transform">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="pedidos-confirmados-contenedor" class="space-y-4 p-1"></div>
                    </div>
                </div>
                <!-- Pedidos Entregados -->
                <div>
                    <div class="collapsible-header flex justify-between items-center w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100 cursor-pointer">
                        <span>Pedidos Entregados</span>
                        <span class="transform transition-transform">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="pedidos-entregados-contenedor" class="space-y-4 p-1"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Columna de Productos -->
        <section>
            <!-- Gesti√≥n de Stock -->
            <div>
                <div class="collapsible-header flex justify-between items-center w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100 cursor-pointer">
                    <span>Gesti√≥n de Productos</span>
                    <span class="transform transition-transform">‚ñº</span>
                </div>
                <div class="collapsible-content open">
                    <div id="productos-contenedor" class="space-y-4 p-1"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Supabase SDK -->
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://cajscvluvmwlllyrrgeb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhanNjdmx1dm13bGxseXJyZ2ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NjU0MDksImV4cCI6MjA3MTE0MTQwOX0.7R8igId24CLfVfDVjy_Q0V1pzy_z_bpxLU933-72_sI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const gananciasDetalle = document.getElementById('ganancias-detalle');
    const gananciasEfectivo = document.getElementById('ganancias-efectivo');
    const gananciasTransferencia = document.getElementById('ganancias-transferencia');
    const gananciasPeriodoContenedor = document.getElementById('ganancias-periodo');
    const costoPeriodoContenedor = document.getElementById('costo-periodo');
    const gananciaNetaPeriodoContenedor = document.getElementById('ganancia-neta-periodo');
    const pedidosPendientesContenedor = document.getElementById('pedidos-pendientes-contenedor');
    const pedidosConfirmadosContenedor = document.getElementById('pedidos-confirmados-contenedor');
    const pedidosEntregadosContenedor = document.getElementById('pedidos-entregados-contenedor');
    const productosContenedor = document.getElementById('productos-contenedor');
    const searchInput = document.getElementById('search-pedidos');
    const fechaInicioInput = document.getElementById('fecha-inicio');
    const fechaFinInput = document.getElementById('fecha-fin');

    let todosLosPedidos = [];
    let todosLosProductos = [];

    const formatearPrecio = (valor) => new Intl.NumberFormat('es-PY', { style: 'currency', currency: 'PYG', maximumFractionDigits: 0 }).format(valor);

    async function cargarDatos() {
        // Cargar Productos primero para tener los costos
        const { data: productos, error: errorProductos } = await supabase.from('productos').select('*').order('nombre');
        if (errorProductos) {
            console.error('Error al cargar productos:', errorProductos);
        } else {
            todosLosProductos = productos;
            renderizarProductos(productos);
        }

        // Cargar Pedidos
        const { data, error } = await supabase.from('pedidos').select('*').order('created_at', { ascending: true });
        if (error) {
            console.error('Error al cargar todos los pedidos:', error);
        } else {
            todosLosPedidos = data;
            filtrarYRenderizarPedidos();
        }
    }

    function filtrarYRenderizarPedidos() {
        const searchTerm = searchInput.value.toLowerCase();
        const fechaInicio = fechaInicioInput.value;
        const fechaFin = fechaFinInput.value;

        let pedidosFiltrados = todosLosPedidos.filter(p => p.nombre_cliente && p.nombre_cliente.toLowerCase().includes(searchTerm));

        const pendientes = pedidosFiltrados.filter(p => !p.confirmado);
        const confirmados = pedidosFiltrados.filter(p => p.confirmado && !p.pagado);
        let entregados = pedidosFiltrados.filter(p => p.pagado);

        // Filtrar entregados por fecha si se ha seleccionado un rango
        let entregadosFiltrados = entregados;
        if (fechaInicio || fechaFin) {
            entregadosFiltrados = entregados.filter(p => {
                const fechaPedido = new Date(p.created_at).toISOString().split('T')[0];
                const inicio = fechaInicio || '1970-01-01';
                const fin = fechaFin || '9999-12-31';
                return fechaPedido >= inicio && fechaPedido <= fin;
            });
        }

        const ingresosPeriodo = entregadosFiltrados.reduce((sum, p) => sum + p.total, 0);
        gananciasPeriodoContenedor.textContent = formatearPrecio(ingresosPeriodo);

        let totalEfectivoPeriodo = 0;
        let totalTransferenciaPeriodo = 0;
        let costoTotalPeriodo = 0;

        entregadosFiltrados.forEach(pedido => {
            if (pedido.metodo_pago === 'Efectivo') totalEfectivoPeriodo += pedido.total;
            else if (pedido.metodo_pago === 'Transferencia') totalTransferenciaPeriodo += pedido.total;
            costoTotalPeriodo += pedido.costo_total_produccion || 0;
        });
        gananciasEfectivo.textContent = formatearPrecio(totalEfectivoPeriodo);
        gananciasTransferencia.textContent = formatearPrecio(totalTransferenciaPeriodo);
        costoPeriodoContenedor.textContent = formatearPrecio(costoTotalPeriodo);
        gananciaNetaPeriodoContenedor.textContent = formatearPrecio(ingresosPeriodo - costoTotalPeriodo);

        renderizarPedidos(pendientes, pedidosPendientesContenedor, 'pendientes');
        renderizarPedidos(confirmados, pedidosConfirmadosContenedor, 'confirmados');
        renderizarPedidos(entregadosFiltrados, pedidosEntregadosContenedor, 'entregados');
    }

    function renderizarPedidos(pedidos, contenedor, tipo) {
        contenedor.innerHTML = '';
        if (pedidos.length === 0) {
            contenedor.innerHTML = `<p class="text-center text-gray-500">No hay pedidos en esta secci√≥n.</p>`;
            return;
        }
        pedidos.forEach(pedido => {
            const pedidoCard = document.createElement('div');
            pedidoCard.className = 'bg-white p-4 rounded-lg shadow-sm';
            let controlesHTML = '';

            if (tipo === 'pendientes') {
                controlesHTML = `
                        <button data-id="${pedido.id}" class="confirmar-pedido-btn btn-secondary text-sm font-bold py-1 px-3 rounded-lg">Confirmar</button>
                        <button data-id="${pedido.id}" class="eliminar-pedido-btn btn-danger text-sm font-bold py-1 px-3 rounded-lg">Eliminar</button>
                    `;
            } else if (tipo === 'confirmados') {
                controlesHTML 