<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador de Costos - Bakesuki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lobster&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDF4F0; }
        .font-lobster { font-family: 'Lobster', cursive; }
        .bakesuki-brand-text { color: #6D2828; }
        .btn-primary { background-color: #D98B99; color: white; }
        .btn-primary:hover { background-color: #C77583; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-edit { background-color: #fbbf24; color: white; }
        .btn-edit:hover { background-color: #f59e0b; }

        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.open { max-height: 2000px; }

        @keyframes click-effect {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .clicked { animation: click-effect 0.2s ease-out; }
    </style>
</head>
<body class="text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-12">
        <h1 class="text-5xl font-lobster bakesuki-brand-text">Calculador de Costos</h1>
        <p class="text-xl text-gray-500 mt-2">Bakesuki</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
        <!-- Columna de Ingredientes -->
        <section>
            <div>
                <div class="collapsible-header flex justify-between items-center w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100 cursor-pointer">
                    <span>Gestión de Ingredientes</span>
                    <span class="transform transition-transform">▼</span>
                </div>
                <div class="collapsible-content open">
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <form id="form-nuevo-ingrediente">
                            <h3 class="font-bold bakesuki-brand-text mb-2">Añadir Nuevo Ingrediente</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input name="nombre" type="text" placeholder="Nombre del Ingrediente" required class="w-full border-gray-300 rounded-md">
                                <input name="costo_compra" type="number" placeholder="Costo de Compra (Gs.)" required class="w-full border-gray-300 rounded-md">
                                <input name="cantidad_compra" type="number" placeholder="Cantidad Comprada" required class="w-full border-gray-300 rounded-md">
                                <select name="unidad_medida" required class="w-full border-gray-300 rounded-md">
                                    <option value="gr">Gramos (gr)</option>
                                    <option value="ml">Mililitros (ml)</option>
                                    <option value="un">Unidades (un)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full mt-4 btn-primary font-bold py-2 px-4 rounded-lg">Añadir Ingrediente</button>
                        </form>
                    </div>
                    <div id="ingredientes-contenedor" class="space-y-2"></div>
                </div>
            </div>
        </section>

        <!-- Columna de Productos -->
        <section>
            <div>
                <div class="collapsible-header flex justify-between items-center w-full text-left text-2xl font-bold bakesuki-brand-text mb-4 p-2 rounded-lg hover:bg-pink-100 cursor-pointer">
                    <span>Costos de Producción por Producto</span>
                    <span class="transform transition-transform">▼</span>
                </div>
                <div class="collapsible-content open">
                    <div class="flex justify-end mb-4">
                        <button id="exportar-excel-btn" class="btn-secondary font-bold py-2 px-4 rounded-lg">Exportar a Excel</button>
                    </div>
                    <div id="productos-contenedor" class="space-y-4 p-1"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Supabase SDK y Librerías -->
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    // SheetJS para exportar a Excel
    import 'https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js';

    const SUPABASE_URL = 'https://cajscvluvmwlllyrrgeb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhanNjdmx1dm13bGxseXJyZ2ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NjU0MDksImV4cCI6MjA3MTE0MTQwOX0.7R8igId24CLfVfDVjy_Q0V1pzy_z_bpxLU933-72_sI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const productosContenedor = document.getElementById('productos-contenedor');
    const ingredientesContenedor = document.getElementById('ingredientes-contenedor');
    const formNuevoIngrediente = document.getElementById('form-nuevo-ingrediente');

    let todosLosProductos = [];
    let todosLosIngredientes = [];

    const formatearPrecio = (valor) => new Intl.NumberFormat('es-PY', { style: 'currency', currency: 'PYG', maximumFractionDigits: 0 }).format(valor);

    async function cargarDatos() {
        // Cargar Ingredientes
        const { data: ingredientes, error: errorIngredientes } = await supabase.from('ingredientes').select('*').order('nombre');
        if (errorIngredientes) console.error('Error al cargar ingredientes:', errorIngredientes);
        else {
            todosLosIngredientes = ingredientes;
            renderizarIngredientes(ingredientes);
        }

        // Cargar Productos
        const { data: productos, error: errorProductos } = await supabase.from('productos').select('*').order('nombre');
        if (errorProductos) console.error('Error al cargar productos:', errorProductos);
        else {
            todosLosProductos = productos;
            renderizarProductos(productos);
        }
    }

    function renderizarIngredientes(ingredientes) {
        ingredientesContenedor.innerHTML = '';
        ingredientes.forEach(ingrediente => {
            const ingredienteCard = document.createElement('div');
            ingredienteCard.className = 'bg-white p-2 rounded-lg shadow-sm flex justify-between items-center';
            ingredienteCard.innerHTML = `
                    <span>${ingrediente.nombre} (${ingrediente.cantidad_compra} ${ingrediente.unidad_medida}) - ${formatearPrecio(ingrediente.costo_compra)}</span>
                    <button data-id="${ingrediente.id}" class="eliminar-ingrediente-btn btn-danger text-xs font-bold py-1 px-2 rounded-lg">x</button>
                `;
            ingredientesContenedor.appendChild(ingredienteCard);
        });
    }

    function renderizarProductos(productos) {
        productosContenedor.innerHTML = '';
        productos.forEach(producto => {
            const productoCard = document.createElement('div');
            productoCard.className = 'bg-white p-4 rounded-lg shadow-sm';

            let costoTotalReceta = 0;
            const receta = producto.receta || [];
            receta.forEach(itemReceta => {
                const ingrediente = todosLosIngredientes.find(i => i.id === itemReceta.ingrediente_id);
                if(ingrediente) {
                    const costoPorUnidad = ingrediente.costo_compra / ingrediente.cantidad_compra;
                    costoTotalReceta += costoPorUnidad * itemReceta.cantidad_usada;
                }
            });

            const unidades = producto.unidades_por_receta || 1;
            const costoProduccionUnitario = costoTotalReceta / unidades;
            const gananciaNeta = producto.precio - costoProduccionUnitario;

            const ingredientesHTML = receta.map(itemReceta => {
                const ingrediente = todosLosIngredientes.find(i => i.id === itemReceta.ingrediente_id);
                return `<li class="text-sm flex justify-between">
                                <span>${ingrediente ? ingrediente.nombre : 'Ingrediente borrado'}: ${itemReceta.cantidad_usada} ${ingrediente ? ingrediente.unidad_medida : ''}</span>
                                <button data-prod-id="${producto.id}" data-ing-id="${ingrediente.id}" class="remover-ingrediente-btn text-red-500 font-bold">x</button>
                             </li>`;
            }).join('');

            const opcionesIngredientesHTML = todosLosIngredientes.map(i => `<option value="${i.id}">${i.nombre} (${i.unidad_medida})</option>`).join('');

            productoCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-bold bakesuki-brand-text">${producto.nombre}</p>
                        <button data-id="${producto.id}" class="editar-receta-btn btn-edit text-sm font-bold py-1 px-3 rounded-lg">Editar Receta</button>
                    </div>
                    <div class="mt-2 text-sm space-y-1">
                        <p>Precio Venta: <span class="font-semibold">${formatearPrecio(producto.precio)}</span></p>
                        <p>Costo Producción (unitario): <span class="font-semibold">${formatearPrecio(costoProduccionUnitario)}</span></p>
                        <p class="font-bold text-green-600">Ganancia Neta (unitaria): <span class="font-semibold">${formatearPrecio(gananciaNeta)}</span></p>
                    </div>
                    <div id="edit-form-${producto.id}" class="collapsible-content mt-4 pt-4 border-t">
                        <form class="form-editar-receta" data-id="${producto.id}">
                             <div class="mb-4">
                                <label class="text-sm font-medium text-gray-700">Unidades que rinde esta receta:</label>
                                <input name="unidades_por_receta" type="number" value="${unidades}" class="w-full border-gray-300 rounded-md text-sm mt-1">
                            </div>
                            <h4 class="font-semibold mb-2">Receta Actual:</h4>
                            <ul class="list-disc list-inside mb-4">${ingredientesHTML || '<li class="text-sm text-gray-500">Sin ingredientes asignados.</li>'}</ul>
                            <div class="space-y-2 bg-gray-50 p-3 rounded-lg">
                                <h4 class="font-semibold">Añadir Ingrediente:</h4>
                                <div class="flex gap-2">
                                    <select name="ingrediente_id" class="w-full border-gray-300 rounded-md text-sm">
                                        <option value="">Selecciona un ingrediente...</option>
                                        ${opcionesIngredientesHTML}
                                    </select>
                                    <input name="cantidad_usada" type="number" placeholder="Cantidad" class="w-1/3 border-gray-300 rounded-md text-sm">
                                </div>
                                <button type="submit" class="btn-primary text-sm font-bold py-1 px-3 rounded-lg">Añadir a Receta</button>
                            </div>
                        </form>
                    </div>
                `;
            productosContenedor.appendChild(productoCard);
        });
    }

    // Eventos
    document.addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.dataset.id;

        if (target.classList.contains('collapsible-header')) {
            const content = target.nextElementSibling;
            content.classList.toggle('open');
        }
        if (target.classList.contains('editar-receta-btn')) {
            document.getElementById(`edit-form-${id}`).classList.toggle('open');
        }
        if (target.classList.contains('eliminar-ingrediente-btn')) {
            if (confirm('¿Seguro que quieres eliminar este ingrediente?')) {
                await supabase.from('ingredientes').delete().eq('id', id);
            }
        }
        if (target.classList.contains('remover-ingrediente-btn')) {
            const productoId = target.dataset.prodId;
            const ingredienteId = target.dataset.ingId;
            const producto = todosLosProductos.find(p => p.id === productoId);
            const nuevaReceta = producto.receta.filter(i => i.ingrediente_id !== ingredienteId);
            await supabase.from('productos').update({ receta: nuevaReceta }).eq('id', productoId);
        }
    });

    formNuevoIngrediente.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(formNuevoIngrediente);
        const ingrediente = {
            nombre: formData.get('nombre'),
            costo_compra: parseInt(formData.get('costo_compra')),
            cantidad_compra: parseInt(formData.get('cantidad_compra')),
            unidad_medida: formData.get('unidad_medida'),
        };
        const { error } = await supabase.from('ingredientes').insert([ingrediente]);
        if (error) {
            console.error('Error al añadir ingrediente:', error);
            alert('Error al añadir ingrediente.');
        } else {
            formNuevoIngrediente.reset();
        }
    });

    productosContenedor.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!e.target.classList.contains('form-editar-receta')) return;

        const form = e.target;
        const productoId = form.dataset.id;
        const ingredienteId = form.ingrediente_id.value;
        const cantidadUsada = parseInt(form.cantidad_usada.value);
        const unidadesPorReceta = parseInt(form.unidades_por_receta.value);

        const producto = todosLosProductos.find(p => p.id === productoId);
        const recetaActual = producto.receta || [];
        let nuevaReceta = [...recetaActual];

        if (ingredienteId && cantidadUsada) {
            nuevaReceta.push({ ingrediente_id: ingredienteId, cantidad_usada: cantidadUsada });
        }

        // Calcular el costo de producción unitario
        let costoTotalReceta = 0;
        nuevaReceta.forEach(itemReceta => {
            const ingrediente = todosLosIngredientes.find(i => i.id === itemReceta.ingrediente_id);
            if(ingrediente) {
                const costoPorUnidad = ingrediente.costo_compra / ingrediente.cantidad_compra;
                costoTotalReceta += costoPorUnidad * itemReceta.cantidad_usada;
            }
        });
        const costoProduccionUnitario = Math.round(costoTotalReceta / (unidadesPorReceta || 1));

        const { error } = await supabase.from('productos').update({
            receta: nuevaReceta,
            unidades_por_receta: unidadesPorReceta,
            costo_produccion_unitario: costoProduccionUnitario // Guardar el costo calculado
        }).eq('id', productoId);

        if(error) console.error("Error al actualizar receta:", error);
        else {
            form.ingrediente_id.value = '';
            form.cantidad_usada.value = '';
        }
    });

    document.getElementById('exportar-excel-btn').addEventListener('click', () => {
        const data = todosLosProductos.map(producto => {
            const gananciaNeta = producto.precio - (producto.costo_produccion_unitario || 0);
            return {
                "Producto": producto.nombre,
                "Precio de Venta": producto.precio,
                "Costo de Producción (unitario)": producto.costo_produccion_unitario || 0,
                "Ganancia Neta (unitaria)": gananciaNeta,
                "Stock Actual": producto.stock
            }
        });

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Costos Bakesuki");
        XLSX.writeFile(workbook, "Costos_Bakesuki.xlsx");
    });

    // Cargar datos y escuchar cambios en tiempo real
    cargarDatos();

    supabase.channel('public-changes')
        .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => {
            console.log('Cambio detectado:', payload);
            cargarDatos();
        })
        .subscribe();

</script>
</body>
</html>
